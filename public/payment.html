<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payment - Edunexus</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="container">
    <h2>Payment</h2>
    <p id="paymentSummary">Preparing payment...</p>
    <button id="payBtn" class="btn btn-primary" disabled>Pay Now</button>
  </main>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    // --- Global variables taaki server se mila data store kar sakein ---
    let cartTotal = 0;
    let cartProductIds = [];
    const API_BASE = "https://edunexus-1-ewni.onrender.com"; // Aapka Render URL
    // ---

    // 1. Naya function jo SERVER se cart laayega
    async function preparePayment() {
      const token = localStorage.getItem('token');
      const summaryEl = document.getElementById('paymentSummary');
      const payBtn = document.getElementById('payBtn');

      if (!token) {
        alert("Please login to continue.");
        window.location.href = 'login.html';
        return;
      }

      try {
        // Token bhej kar server se cart fetch karein
        const res = await fetch(`${API_BASE}/api/cart`, {
          method: 'GET',
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (!res.ok) {
          throw new Error("Failed to fetch cart data.");
        }

        const cart = await res.json();

        if (!cart.items || cart.items.length === 0) {
          // Yeh hai asli "Cart empty" check
          alert('Your cart is empty.'); 
          window.location.href = 'marketplace.html'; // Wapas shop par bhej dein
          return;
        }

        // Server ke data se total calculate karein
        let total = 0;
        let productIds = [];
        cart.items.forEach(item => {
          if (item.productId) { // Check karein ki product exist karta hai
            total += (item.productId.price || 0) * (item.quantity || 1);
            productIds.push(item.productId._id); // Payment ke liye IDs store karein
          }
        });

        // Global variables mein data save karein taaki "Pay" button use kar sake
        cartTotal = total;
        cartProductIds = productIds;

        // UI Update karein
        summaryEl.innerText = `Pay ₹${total.toFixed(2)} for ${cart.items.length} item(s).`;
        payBtn.disabled = false; // Ab "Pay Now" button ko enable karein

      } catch (error) {
        console.error("Payment prep error:", error);
        summaryEl.innerText = "Error loading cart. Please go back.";
      }
    }

    // 2. "Pay Now" button ab global variables use karega
    document.getElementById('payBtn').addEventListener('click', async () => {
      const token = localStorage.getItem('token');
      
      // Data localStorage se nahi, global variable se lein
      const total = cartTotal;
      const productIds = cartProductIds;

      if (total === 0 || productIds.length === 0) {
        alert("Cart is empty or total is zero. Cannot proceed.");
        return;
      }

      // Aapka Mock payment flow (Yeh ab sahi data use karega)
      alert('Simulating payment success...');
      const fakeResponse = {
        razorpay_payment_id: "pay_test123",
        razorpay_order_id: "order_test123",
        razorpay_signature: "sig_test123"
      };

      // Server ko 'purchases' route par call karein
      const r = await fetch(`${API_BASE}/api/purchases`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ productIds: productIds, payment: fakeResponse })
      });

      if (!r.ok) {
        alert('Payment record failed');
        return;
      }

      // Yahaan humein server par cart clear karne ka API call karna chahiye
      // Abhi ke liye, hum bas redirect kar rahe hain
      
      alert('Fake payment successful — materials unlocked');
      window.location.href = 'index.html'; // Home page par bhej dein
    });

    // 3. Page load hote hi naya function call karein
    preparePayment();

  </script>
</body>
</html>