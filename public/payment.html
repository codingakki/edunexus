<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payment - Edunexus</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="container">
    <h2>Payment</h2>
    <p id="paymentSummary">Preparing payment...</p>
    <button id="payBtn" class="btn btn-primary" disabled>Pay Now</button>
  </main>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  
  <script>
    const API_BASE = "https://edunexus-1-ewni.onrender.com";
    let cartTotal = 0; // Total ko store karne ke liye
    let cartProductIds = []; // Product IDs ko store karne ke liye

    // --- Login State Logic (Updated) ---
    // (Yeh function abhi yahaan zyada kuch karega nahi, kyunki header nahi hai)
    function checkLoginState() {
      const token = localStorage.getItem("token");
      const loginLink = document.getElementById("loginLink");
      const cartLink = document.getElementById("cartLink");

      if (!loginLink) {
        return; // Header nahi hai, toh kuch na karein
      }
      // ... (baaki ka header logic, agar aap header add karte hain) ...
    }

    // --- Kadam 1: Page load hote hi cart fetch karein ---
    async function preparePayment() {
      const token = localStorage.getItem("token");
      const summaryEl = document.getElementById('paymentSummary');
      const payBtn = document.getElementById('payBtn');

      if (!token) {
        alert("Please login to continue.");
        window.location.href = 'login.html';
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/api/cart`, {
          method: 'GET',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) throw new Error("Failed to fetch cart data.");

        const cart = await res.json();
        if (!cart.items || cart.items.length === 0) {
          alert('Your cart is empty.'); 
          window.location.href = 'marketplace.html';
          return;
        }

        let total = 0;
        let productIds = []; // IDs yahaan collect karein
        cart.items.forEach(item => {
          if (item.productId) {
            total += (item.productId.price || 0) * (item.quantity || 1);
            productIds.push(item.productId._id); // Har product ki ID save karein
          }
        });
        
        cartTotal = total; // Total save karein
        cartProductIds = productIds; // Product IDs save karein
        summaryEl.innerText = `Pay ₹${total.toFixed(2)} for ${cart.items.length} item(s).`;
        payBtn.disabled = false;
      } catch (error) {
        console.error("Payment prep error:", error);
        summaryEl.innerText = "Error loading cart. Please go back.";
      }
    }

    // --- Kadam 2: "Pay Now" button ka click event ---
    document.getElementById('payBtn').addEventListener('click', async () => {
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user'));
      
      try {
        // 1. Backend se 'order_id' fetch karein
        const orderRes = await fetch(`${API_BASE}/api/payment/create-order`, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        
        if (!orderRes.ok) {
          alert("Failed to create order. Cart might be empty.");
          return;
        }
        
        const order = await orderRes.json(); 

        // 2. Razorpay options banayein
        const options = {
          key: "rzp_test_ReY7aTmyZrSxVZ", // Aapki Key ID
          amount: order.amount,
          currency: "INR",
          name: "Edunexus",
          description: "Course Purchase",
          order_id: order.id,

          // 3. Handler function
          handler: async function (response) {
            // Payment details ko verification ke liye backend par bhejein
            const verifyRes = await fetch(`${API_BASE}/api/payment/verify-payment`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
              },
              body: JSON.stringify({
                razorpay_order_id: response.razorpay_order_id,
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_signature: response.razorpay_signature
              })
            });

            if (!verifyRes.ok) {
              alert("❌ Payment verification failed. Please contact support.");
              return;
            }

            // Payment verify ho gayi! Ab purchase record karein
            const purchaseRes = await fetch(`${API_BASE}/api/purchases`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
              },
              body: JSON.stringify({
                productIds: cartProductIds, // Save ki gayi IDs bhejein
                payment: response // Razorpay ka response bhejein
              })
            });

            if (!purchaseRes.ok) {
              alert("❌ Payment verified, but failed to record purchase.");
              return;
            }

            // Sab kuch successful
            alert("✅ Payment successful! Your purchase is complete.");
            window.location.href = 'my-purchases.html'; // Seedha "My Purchases" page par bhej dein
          },
          
          prefill: {
            name: user.name || "",
            email: user.email || ""
          },
          theme: {
            color: "#6a1b9a"
          }
        };

        // 4. Razorpay popup kholein
        const rzp = new Razorpay(options);
        rzp.open();

      } catch (error) {
        console.error("Payment initiation error:", error);
        alert("Error starting payment.");
      }
    });

    // --- Kadam 3: Page load hote hi run karein ---
    document.addEventListener("DOMContentLoaded", () => {
      checkLoginState();
      preparePayment();
    });
  </script>
</body>
</html>